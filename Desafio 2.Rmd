```{r}
# Importa a biblioteca pandas
import pandas as pd

arquivo = 'flights.csv'
tamchunk = 100000
resultados = []

NOME_COLUNA_CIA = 'AIRLINE'

def getStats(input_df):
    colunas_interesse = ['YEAR', 'MONTH', 'DAY', NOME_COLUNA_CIA, 'ARRIVAL_DELAY']
    
    if not all(coluna in input_df.columns for coluna in colunas_interesse):
        return pd.DataFrame()
        
    df_selec = input_df[colunas_interesse]
    df_filtr = df_selec[df_selec[NOME_COLUNA_CIA].isin(['AA', 'DL', 'UA', 'US'])]
    df_sem_na = df_filtr.dropna(subset=['ARRIVAL_DELAY'])
    
    df_atraso = df_sem_na.copy()
    df_atraso['IS_DELAYED'] = (df_atraso['ARRIVAL_DELAY'] > 10).astype(int)

    stats = df_atraso.groupby(['YEAR', 'MONTH', 'DAY', NOME_COLUNA_CIA]).agg(
        TOTAL_FLIGHTS=(NOME_COLUNA_CIA, 'size'),
        DELAYED_FLIGHTS=('IS_DELAYED', 'sum')
    ).reset_index()
    
    return stats

# Leitura e processamento em chunks
print("Iniciando a leitura e processamento do arquivo")

leitor_chunks = pd.read_csv(arquivo, chunksize=tamchunk, low_memory=False)

for i, chunk in enumerate(leitor_chunks):
    print(f"Processando chunk {i+1}...")
    resultado_chunk = getStats(chunk)
    resultados.append(resultado_chunk)
    
print("Processamento concluído.")
print("Combinando resultados...")

resultados = [df for df in resultados if not df.empty]
df_stats_bruto = pd.concat(resultados)

df_stats_agregado = df_stats_bruto.groupby(['YEAR', 'MONTH', 'DAY', NOME_COLUNA_CIA]).agg(
    TOTAL_FLIGHTS=('TOTAL_FLIGHTS', 'sum'),
    DELAYED_FLIGHTS=('DELAYED_FLIGHTS', 'sum')
).reset_index()


print(df_stats_agregado.head())

def computeStats(df_input):
    # Copia o dataframe
    df = df_input.copy()
    
    # 1. Calcula o percentual de atrasos
    df['Perc'] = df['DELAYED_FLIGHTS'] / df['TOTAL_FLIGHTS']
    
    # 2. Cria a coluna de Data a partir de YEAR, MONTH, DAY
    df['Data'] = pd.to_datetime(df[['YEAR', 'MONTH', 'DAY']])
    
    # 3. Renomeia a coluna 'AIRLINE' para 'Cia'
    df = df.rename(columns={'AIRLINE': 'Cia'})
    
    # 4. Seleciona apenas as colunas finais de interesse
    df_final = df[['Cia', 'Data', 'Perc']]
    
    return df_final

df_pronto_plotar = computeStats(df_stats_agregado)

# Mostra as primeiras linhas da tabela final
print(df_pronto_plotar.head())

dados_aa = df_pronto_plotar[df_pronto_plotar['Cia'] == 'AA']
# Seleciona a coluna 'Perc' como os valores.
serie_aa = dados_aa.set_index('Data')['Perc']

# Análisar as 5 primeiras linhas para confirmar o formato
print(serie_aa.head())

# Importa as bibliotecas necessárias para o gráfico
import calmap
import matplotlib.pyplot as plt 

# Define o tamanho da figura
plt.figure(figsize=(16, 8))

# O argumento 'cmap' define a paleta de cores
calmap.yearplot(serie_aa, cmap='RdBu_r')

# Adiciona um título ao gráfico
plt.title('Percentual de Voos com Atraso (>10 min) - American Airlines (AA) em 2015', fontsize=16)

# Mostra o gráfico gerado
plt.show()

# 1. Filtra o dataframe para a Delta
dados_dl = df_pronto_plotar[df_pronto_plotar['Cia'] == 'DL']

# 2. Prepara a série de dados para o gráfico
serie_dl = dados_dl.set_index('Data')['Perc']

# 3. Plota o gráfico
plt.figure(figsize=(16, 8)) 
calmap.yearplot(serie_dl, cmap='RdBu_r') 
plt.title('Percentual de Voos com Atraso (>10 min) - Delta Air Lines (DL) em 2015', fontsize=16) 
plt.show() 

# Filtra o dataframe para a United
dados_ua = df_pronto_plotar[df_pronto_plotar['Cia'] == 'UA']

serie_ua = dados_ua.set_index('Data')['Perc']

plt.figure(figsize=(16, 8))
calmap.yearplot(serie_ua, cmap='RdBu_r')
plt.title('Percentual de Voos com Atraso (>10 min) - United Airlines (UA) em 2015', fontsize=16)
plt.show()

# Filtra o dataframe para a US Airways
dados_us = df_pronto_plotar[df_pronto_plotar['Cia'] == 'US']

serie_us = dados_us.set_index('Data')['Perc']

plt.figure(figsize=(16, 8))
calmap.yearplot(serie_us, cmap='RdBu_r')
plt.title('Percentual de Voos com Atraso (>10 min) - US Airways (US) em 2015', fontsize=16)
plt.show()
```


